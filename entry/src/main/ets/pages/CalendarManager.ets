// CalendarManager.ets - æ—¥å†è´¦æˆ·ç®¡ç†é¡µé¢
// å¯¼å…¥é¡µé¢è·¯ç”±æ¨¡å—
import { router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { calendarManager } from '@kit.CalendarKit';
import { promptAction } from '@kit.ArkUI';
import { calendarMgr, mContext } from '../entryability/EntryAbility';

@Entry
@Component
struct CalendarManager {
  @State message: string = 'ğŸ“… æ—¥å†è´¦æˆ·ç®¡ç†'
  @State calendar: calendarManager.Calendar | undefined = undefined
  @State calendarMgr: calendarManager.CalendarManager | undefined = undefined
  @State isCalendarAccountCreated: boolean = false

  // é¡µé¢æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ
  aboutToAppear() {
    this.checkCalendarAccountStatus();
  }

  // æ£€æŸ¥æ—¥å†è´¦æˆ·çŠ¶æ€
  async checkCalendarAccountStatus() {
    try {
      // å…ˆåˆå§‹åŒ–æ—¥å†ç®¡ç†å™¨
      if (!this.calendarMgr) {
        await this.initCalendarManager();
      }
      
      if (!this.calendarMgr) {
        return;
      }

      // æ£€æŸ¥æ—¥å†è´¦æˆ·æ˜¯å¦å­˜åœ¨
      const calendarAccount: calendarManager.CalendarAccount = {
        name: 'AICalendar',
        type: calendarManager.CalendarType.LOCAL,
        displayName: 'AIæ—¥å†'
      };

      try {
        this.calendar = await this.calendarMgr.getCalendar(calendarAccount);
        this.isCalendarAccountCreated = true;
        console.info('Calendar account exists');
      } catch (getError) {
        this.isCalendarAccountCreated = false;
        console.info('Calendar account does not exist');
      }
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`Failed to check calendar account status. Code: ${code}, message: ${message}`);
    }
  }

  // åˆå§‹åŒ–æ—¥å†ç®¡ç†å™¨
  async initCalendarManager() {
    try {
      if (calendarMgr) {
        this.calendarMgr = calendarMgr;
        console.info('Calendar manager initialized from global');
      } else {
        console.error('Global calendar manager is not available');
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè¯·é‡å¯åº”ç”¨',
          duration: 2000
        });
      }
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`Failed to initialize calendar manager. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆå§‹åŒ–æ—¥å†ç®¡ç†å™¨å¤±è´¥: ' + message,
        duration: 2000
      });
    }
  }

  // åˆå§‹åŒ–æ—¥å†è´¦æˆ·
  async initCalendarAccount() {
    try {
      if (!this.calendarMgr) {
        await this.initCalendarManager();
      }
      
      if (!this.calendarMgr) {
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–',
          duration: 2000
        });
        return;
      }
      
      // åˆ›å»ºæ—¥å†è´¦æˆ·
      const calendarAccount: calendarManager.CalendarAccount = {
        name: 'AICalendar',
        type: calendarManager.CalendarType.LOCAL,
        displayName: 'AIæ—¥å†'
      };
      
      try {
        // å…ˆå°è¯•è·å–ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
        this.calendar = await this.calendarMgr.getCalendar(calendarAccount);
        promptAction.showToast({
          message: 'æ—¥å†è´¦æˆ·å·²å­˜åœ¨',
          duration: 2000
        });
        this.isCalendarAccountCreated = true;
      } catch (getError) {
        // è´¦æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è´¦æˆ·
        this.calendar = await this.calendarMgr.createCalendar(calendarAccount);
        
        // è®¾ç½®æ—¥å†é…ç½®
        const config: calendarManager.CalendarConfig = {
          enableReminder: true,
          color: '#4CAF50'
        };
        await this.calendar.setConfig(config);
        
        promptAction.showToast({
          message: 'æ—¥å†è´¦æˆ·åˆ›å»ºæˆåŠŸ',
          duration: 2000
        });
        this.isCalendarAccountCreated = true;
        console.info('Calendar account created successfully');
      }
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`Failed to initialize calendar account. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆå§‹åŒ–æ—¥å†è´¦æˆ·å¤±è´¥: ' + message,
        duration: 2000
      });
    }
  }

  // åˆ é™¤æ—¥å†è´¦æˆ·
  async deleteCalendarAccount() {
    try {
      if (!this.calendarMgr) {
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–',
          duration: 2000
        });
        return;
      }
      
      if (!this.calendar) {
        promptAction.showToast({
          message: 'æ²¡æœ‰å¯åˆ é™¤çš„æ—¥å†è´¦æˆ·',
          duration: 2000
        });
        return;
      }
      
      // åˆ é™¤æ—¥å†è´¦æˆ·
      await this.calendarMgr.deleteCalendar(this.calendar);
      
      this.calendar = undefined;
      this.isCalendarAccountCreated = false;
      
      promptAction.showToast({
        message: 'æ—¥å†è´¦æˆ·åˆ é™¤æˆåŠŸ',
        duration: 2000
      });
      
      console.info('Calendar account deleted successfully');
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`Failed to delete calendar account. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆ é™¤æ—¥å†è´¦æˆ·å¤±è´¥: ' + message,
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜å’Œè¿”å›æŒ‰é’®
      Row() {
        Button() {
          Text('  â† è¿”å›  ')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .type(ButtonType.Capsule)
        .backgroundColor('#0D9FFB')
        .height(40)
        .onClick(() => {
          router.back()
        })
        
        Blank()
        
        Text(this.message)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .margin({ bottom: 30 })
      
      // çŠ¶æ€æ˜¾ç¤º
      Column() {
        Text('ğŸ“Š è´¦æˆ·çŠ¶æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 16 })
        
        Row() {
          Text('æ—¥å†è´¦æˆ·çŠ¶æ€ï¼š')
            .fontSize(16)
          
          Text(this.isCalendarAccountCreated ? 'âœ… å·²åˆ›å»º' : 'âŒ æœªåˆ›å»º')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.isCalendarAccountCreated ? '#4CAF50' : '#F44336')
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .margin({ bottom: 12 })
        
        if (this.isCalendarAccountCreated && this.calendar) {
          Column() {
            Text('è´¦æˆ·ä¿¡æ¯ï¼š')
              .fontSize(14)
              .fontColor($r('sys.color.ohos_id_color_text_secondary'))
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            Text(`â€¢ è´¦æˆ·åç§°: AICalendar`)
              .fontSize(14)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 4 })
            
            Text(`â€¢ æ˜¾ç¤ºåç§°: AIæ—¥å†`)
              .fontSize(14)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 4 })
            
            Text(`â€¢ è´¦æˆ·ç±»å‹: æœ¬åœ°è´¦æˆ·`)
              .fontSize(14)
              .alignSelf(ItemAlign.Start)
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
          .borderRadius(8)
        }
      }
      .width('100%')
      .padding(20)
      .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
      .borderRadius(12)
      .margin({ bottom: 30 })
      
      // æ“ä½œæŒ‰é’®
      Column() {
        Text('ğŸ› ï¸ è´¦æˆ·æ“ä½œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 16 })
        
        if (!this.isCalendarAccountCreated) {
          Button() {
            Text('ğŸš€ åˆå§‹åŒ–æ—¥å†è´¦æˆ·')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .type(ButtonType.Capsule)
          .backgroundColor('#4CAF50')
          .width('100%')
          .height(55)
          .onClick(() => {
            this.initCalendarAccount();
          })
          .margin({ bottom: 16 })
        } else {
          Button() {
            Text('ğŸ”„ é‡æ–°æ£€æŸ¥çŠ¶æ€')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .type(ButtonType.Capsule)
          .backgroundColor('#2196F3')
          .width('100%')
          .height(50)
          .onClick(() => {
            this.checkCalendarAccountStatus();
          })
          .margin({ bottom: 16 })
          
          Button() {
            Text('ğŸ—‘ï¸ åˆ é™¤æ—¥å†è´¦æˆ·')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .type(ButtonType.Capsule)
          .backgroundColor('#F44336')
          .width('100%')
          .height(50)
          .onClick(() => {
            this.deleteCalendarAccount();
          })
        }
      }
      .width('100%')
      .padding(20)
      
      Blank()
      
      // è¯´æ˜æ–‡å­—
      Column() {
        Text('ğŸ’¡ ä½¿ç”¨è¯´æ˜')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 12 })
        
        Text('â€¢ æ—¥å†è´¦æˆ·æ˜¯å­˜å‚¨æ—¥ç¨‹çš„åŸºç¡€ï¼Œéœ€è¦å…ˆåˆ›å»ºè´¦æˆ·æ‰èƒ½æ·»åŠ æ—¥ç¨‹')
          .fontSize(14)
          .fontColor($r('sys.color.ohos_id_color_text_secondary'))
          .margin({ bottom: 8 })
        
        Text('â€¢ åˆ é™¤è´¦æˆ·å°†åŒæ—¶åˆ é™¤è¯¥è´¦æˆ·ä¸‹çš„æ‰€æœ‰æ—¥ç¨‹ï¼Œè¯·è°¨æ…æ“ä½œ')
          .fontSize(14)
          .fontColor($r('sys.color.ohos_id_color_text_secondary'))
          .margin({ bottom: 8 })
        
        Text('â€¢ å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å°è¯•é‡æ–°æ£€æŸ¥çŠ¶æ€æˆ–é‡å¯åº”ç”¨')
          .fontSize(14)
          .fontColor($r('sys.color.ohos_id_color_text_secondary'))
      }
      .width('100%')
      .padding(20)
      .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .padding(20)
  }
} 