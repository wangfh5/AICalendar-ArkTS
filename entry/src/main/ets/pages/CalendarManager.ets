// CalendarManager.ets - æ—¥å†è´¦æˆ·ç®¡ç†é¡µé¢
// å¯¼å…¥é¡µé¢è·¯ç”±æ¨¡å—
import { router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { calendarManager } from '@kit.CalendarKit';
import { promptAction } from '@kit.ArkUI';
import { calendarMgr, mContext, AIConfig } from '../entryability/EntryAbility';
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';

// é»˜è®¤è´¦æˆ·é…ç½®ç±»
class DefaultCalendarConfig {
  private static readonly PREF_NAME: string = 'default_calendar_config';
  private static readonly DEFAULT_CALENDAR_KEY: string = 'default_calendar_name';

  static async saveDefaultCalendar(context: common.UIAbilityContext, calendarName: string): Promise<void> {
    try {
      const pref = await preferences.getPreferences(context, DefaultCalendarConfig.PREF_NAME);
      await pref.put(DefaultCalendarConfig.DEFAULT_CALENDAR_KEY, calendarName);
      await pref.flush();
    } catch (error) {
      console.error('ä¿å­˜é»˜è®¤æ—¥å†é…ç½®å¤±è´¥:', error);
    }
  }

  static async getDefaultCalendar(context: common.UIAbilityContext): Promise<string> {
    try {
      const pref = await preferences.getPreferences(context, DefaultCalendarConfig.PREF_NAME);
      return await pref.get(DefaultCalendarConfig.DEFAULT_CALENDAR_KEY, '') as string;
    } catch (error) {
      console.error('è·å–é»˜è®¤æ—¥å†é…ç½®å¤±è´¥:', error);
      return '';
    }
  }
}

@Entry
@Component
struct CalendarManager {
  @State message: string = 'ğŸ“… æ—¥å†è´¦æˆ·ç®¡ç†'
  @State allCalendars: calendarManager.Calendar[] = []
  @State selectedCalendarName: string = ''
  @State defaultCalendarName: string = ''
  @State isLoading: boolean = false
  @State showCreateDialog: boolean = false
  
  // æ–°å»ºè´¦æˆ·ç›¸å…³çŠ¶æ€
  @State newCalendarName: string = ''
  @State newCalendarDisplayName: string = ''
  @State newCalendarColor: string = '#4CAF50'
  @State enableReminder: boolean = true

  // é¡µé¢æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ
  async aboutToAppear() {
    await this.loadDefaultCalendar();
    await this.loadAllCalendars();
  }

  // åŠ è½½é»˜è®¤æ—¥å†é…ç½®
  async loadDefaultCalendar() {
    if (mContext) {
      this.defaultCalendarName = await DefaultCalendarConfig.getDefaultCalendar(mContext);
      this.selectedCalendarName = this.defaultCalendarName;
    }
  }

  // è·å–æ‰€æœ‰æ—¥å†è´¦æˆ·
  async loadAllCalendars() {
    try {
      this.isLoading = true;
      
      if (!calendarMgr) {
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè¯·é‡å¯åº”ç”¨',
          duration: 2000
        });
        return;
      }

      // è·å–æ‰€æœ‰æ—¥å†è´¦æˆ·
      this.allCalendars = await calendarMgr.getAllCalendars();
      
      console.info(`è·å–åˆ° ${this.allCalendars.length} ä¸ªæ—¥å†è´¦æˆ·`);
      
      // å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤è´¦æˆ·ï¼Œä¸”æœ‰å¯ç”¨è´¦æˆ·ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
      if (!this.selectedCalendarName && this.allCalendars.length > 0) {
        const firstCalendar = this.allCalendars[0];
        const account = firstCalendar.getAccount();
        this.selectedCalendarName = account.name;
      }
      
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`è·å–æ—¥å†è´¦æˆ·å¤±è´¥. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'è·å–æ—¥å†è´¦æˆ·å¤±è´¥: ' + message,
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  // è®¾ç½®é»˜è®¤æ—¥å†è´¦æˆ·
  async setDefaultCalendar(calendarName: string) {
    try {
      if (mContext) {
        await DefaultCalendarConfig.saveDefaultCalendar(mContext, calendarName);
        this.defaultCalendarName = calendarName;
        this.selectedCalendarName = calendarName;
        
        promptAction.showToast({
          message: `å·²è®¾ç½® "${calendarName}" ä¸ºé»˜è®¤æ—¥å†`,
          duration: 2000
        });
      }
    } catch (error) {
      console.error('è®¾ç½®é»˜è®¤æ—¥å†å¤±è´¥:', error);
      promptAction.showToast({
        message: 'è®¾ç½®é»˜è®¤æ—¥å†å¤±è´¥',
        duration: 2000
      });
    }
  }

  // åˆ›å»ºæ–°çš„æ—¥å†è´¦æˆ·
  async createNewCalendar() {
    try {
      if (!calendarMgr) {
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–',
          duration: 2000
        });
        return;
      }

      if (!this.newCalendarName.trim()) {
        promptAction.showToast({
          message: 'è¯·è¾“å…¥æ—¥å†è´¦æˆ·åç§°',
          duration: 2000
        });
        return;
      }

      // æ£€æŸ¥è´¦æˆ·åæ˜¯å¦å·²å­˜åœ¨
      const existingCalendar = this.allCalendars.find(cal => {
        const account = cal.getAccount();
        return account.name === this.newCalendarName.trim();
      });

      if (existingCalendar) {
        promptAction.showToast({
          message: 'è¯¥è´¦æˆ·åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°',
          duration: 2000
        });
        return;
      }

      this.isLoading = true;

      // åˆ›å»ºæ—¥å†è´¦æˆ·
      const calendarAccount: calendarManager.CalendarAccount = {
        name: this.newCalendarName.trim(),
        type: calendarManager.CalendarType.LOCAL,
        displayName: this.newCalendarDisplayName.trim() || this.newCalendarName.trim()
      };

      const newCalendar = await calendarMgr.createCalendar(calendarAccount);

      // è®¾ç½®æ—¥å†é…ç½®
      const config: calendarManager.CalendarConfig = {
        enableReminder: this.enableReminder,
        color: this.newCalendarColor
      };
      await newCalendar.setConfig(config);

      promptAction.showToast({
        message: 'æ—¥å†è´¦æˆ·åˆ›å»ºæˆåŠŸ',
        duration: 2000
      });

      // é‡æ–°åŠ è½½è´¦æˆ·åˆ—è¡¨
      await this.loadAllCalendars();
      
      // å…³é—­åˆ›å»ºå¯¹è¯æ¡†å¹¶æ¸…ç©ºè¡¨å•
      this.showCreateDialog = false;
      this.clearCreateForm();

    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`åˆ›å»ºæ—¥å†è´¦æˆ·å¤±è´¥. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆ›å»ºæ—¥å†è´¦æˆ·å¤±è´¥: ' + message,
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ é™¤æ—¥å†è´¦æˆ·
  async deleteCalendar(calendar: calendarManager.Calendar) {
    try {
      if (!calendarMgr) {
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–',
          duration: 2000
        });
        return;
      }

      const account = calendar.getAccount();
      
      // ç¡®è®¤åˆ é™¤
      // æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥ä½¿ç”¨ç³»ç»Ÿå¯¹è¯æ¡†ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨toastæç¤º
      await calendarMgr.deleteCalendar(calendar);
      
      promptAction.showToast({
        message: `æ—¥å†è´¦æˆ· "${account.displayName}" åˆ é™¤æˆåŠŸ`,
        duration: 2000
      });

      // å¦‚æœåˆ é™¤çš„æ˜¯é»˜è®¤è´¦æˆ·ï¼Œæ¸…ç©ºé»˜è®¤è®¾ç½®
      if (this.defaultCalendarName === account.name) {
        this.defaultCalendarName = '';
        this.selectedCalendarName = '';
        if (mContext) {
          await DefaultCalendarConfig.saveDefaultCalendar(mContext, '');
        }
      }

      // é‡æ–°åŠ è½½è´¦æˆ·åˆ—è¡¨
      await this.loadAllCalendars();

    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`åˆ é™¤æ—¥å†è´¦æˆ·å¤±è´¥. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆ é™¤æ—¥å†è´¦æˆ·å¤±è´¥: ' + message,
        duration: 2000
      });
    }
  }

  // æ¸…ç©ºåˆ›å»ºè¡¨å•
  clearCreateForm() {
    this.newCalendarName = '';
    this.newCalendarDisplayName = '';
    this.newCalendarColor = '#4CAF50';
    this.enableReminder = true;
  }

  // è·å–æ—¥å†è´¦æˆ·çš„é…ç½®ä¿¡æ¯
  getCalendarConfigInfo(calendar: calendarManager.Calendar): string {
    try {
      const config = calendar.getConfig();
      return `é¢œè‰²: ${config.color || 'é»˜è®¤'} | æé†’: ${config.enableReminder ? 'å¼€å¯' : 'å…³é—­'}`;
    } catch (error) {
      return 'é…ç½®ä¿¡æ¯è·å–å¤±è´¥';
    }
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹
      Column() {
        // æ ‡é¢˜å’Œè¿”å›æŒ‰é’®
        Row() {
          Button() {
            Text('  â† è¿”å›  ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .type(ButtonType.Capsule)
          .backgroundColor('#0D9FFB')
          .height(40)
          .onClick(() => {
            router.back()
          })
          
          Blank()
          
          Text(this.message)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        .margin({ bottom: 20 })

        // åŠ è½½çŠ¶æ€
        if (this.isLoading) {
          Row() {
            LoadingProgress()
              .width(30)
              .height(30)
              .color('#4CAF50')
            
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .margin({ left: 12 })
          }
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 20 })
        }

        // æ“ä½œæŒ‰é’®åŒºåŸŸ
        Row() {
          Button() {
            Text('ğŸ”„ åˆ·æ–°åˆ—è¡¨')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .type(ButtonType.Capsule)
          .backgroundColor('#2196F3')
          .width('45%')
          .height(45)
          .onClick(() => {
            this.loadAllCalendars();
          })

          Button() {
            Text('â• æ–°å»ºè´¦æˆ·')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .type(ButtonType.Capsule)
          .backgroundColor('#4CAF50')
          .width('45%')
          .height(45)
          .onClick(() => {
            this.showCreateDialog = true;
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ bottom: 20 })

        // é»˜è®¤è´¦æˆ·æ˜¾ç¤º
        if (this.defaultCalendarName) {
          Column() {
            Text('ğŸ¯ å½“å‰é»˜è®¤è´¦æˆ·')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 12 })
            
            Text(`"${this.defaultCalendarName}"`)
              .fontSize(16)
              .fontColor('#4CAF50')
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
          .borderRadius(12)
          .margin({ bottom: 20 })
        }

                // æ—¥å†è´¦æˆ·åˆ—è¡¨
        Column() {
          Text(`ğŸ“‹ æ‰€æœ‰æ—¥å†è´¦æˆ· (${this.allCalendars.length})`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 16 })

          // å¯æ»šåŠ¨çš„è´¦æˆ·åˆ—è¡¨
          Scroll() {
            Column() {
              if (this.allCalendars.length === 0 && !this.isLoading) {
                Text('æš‚æ— æ—¥å†è´¦æˆ·ï¼Œè¯·åˆ›å»ºä¸€ä¸ªæ–°è´¦æˆ·')
                  .fontSize(16)
                  .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                  .textAlign(TextAlign.Center)
                  .margin({ top: 40, bottom: 40 })
              } else {
                ForEach(this.allCalendars, (calendar: calendarManager.Calendar, index: number) => {
                  Column() {
                    Text(calendar.getAccount().displayName || calendar.getAccount().name)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .margin({ bottom: 8 })
                    
                    Text(`è´¦æˆ·å: ${calendar.getAccount().name}`)
                      .fontSize(14)
                      .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                      .margin({ bottom: 4 })
                    
                    Text(this.getCalendarConfigInfo(calendar))
                      .fontSize(12)
                      .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                      .margin({ bottom: 12 })
                    
                    Row() {
                      if (this.defaultCalendarName !== calendar.getAccount().name) {
                        Button('è®¾ä¸ºé»˜è®¤')
                          .fontSize(12)
                          .type(ButtonType.Capsule)
                          .backgroundColor('#FF9800')
                          .height(32)
                          .onClick(() => {
                            this.setDefaultCalendar(calendar.getAccount().name);
                          })
                          .margin({ right: 8 })
                      }
                      
                      Button('åˆ é™¤')
                        .fontSize(12)
                        .type(ButtonType.Capsule)
                        .backgroundColor('#F44336')
                        .height(32)
                        .onClick(() => {
                          this.deleteCalendar(calendar);
                        })
                    }
                    .justifyContent(FlexAlign.End)
                  }
                  .width('100%')
                  .padding(16)
                  .backgroundColor($r('sys.color.ohos_id_color_background'))
                  .borderRadius(8)
                  .margin({ bottom: 12 })
                  .border({
                    width: this.selectedCalendarName === calendar.getAccount().name ? 2 : 1,
                    color: this.selectedCalendarName === calendar.getAccount().name ? '#4CAF50' : $r('sys.color.ohos_id_color_list_separator')
                  })
                  .onClick(() => {
                    this.selectedCalendarName = calendar.getAccount().name;
                  })
                })
              }
            }
            .width('100%')
          }
          .width('100%')
          .layoutWeight(1)
          .scrollable(ScrollDirection.Vertical)
          .scrollBar(BarState.Auto)
        }
        .width('100%')
        .layoutWeight(1)

        // ä½¿ç”¨è¯´æ˜ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰
        Column() {
          Text('ğŸ’¡ ä½¿ç”¨è¯´æ˜')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
          
          Text('â€¢ é€‰æ‹©è´¦æˆ·ä½œä¸ºé»˜è®¤ï¼ŒAIæ—¥ç¨‹å°†æ·»åŠ åˆ°è¯¥è´¦æˆ· â€¢ å¯åˆ›å»ºå¤šä¸ªè´¦æˆ·åˆ†ç±»ç®¡ç† â€¢ åˆ é™¤è´¦æˆ·ä¼šåˆ é™¤æ‰€æœ‰æ—¥ç¨‹')
            .fontSize(12)
            .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
        .padding(12)
        .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
        .borderRadius(8)
        .margin({ top: 16 })
      }
      .width('100%')
      .height('100%')
      .padding(20)

      // åˆ›å»ºè´¦æˆ·å¯¹è¯æ¡†
      if (this.showCreateDialog) {
        Column() {
          Blank()
          
          Column() {
            Text('â• åˆ›å»ºæ–°æ—¥å†è´¦æˆ·')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })
            
            // è´¦æˆ·åç§°
            Column() {
              Text('è´¦æˆ·åç§° *')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              TextInput({ 
                placeholder: 'è¯·è¾“å…¥è´¦æˆ·åç§°ï¼ˆè‹±æ–‡ï¼‰',
                text: this.newCalendarName
              })
                .onChange((value: string) => {
                  this.newCalendarName = value;
                })
                .width('100%')
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // æ˜¾ç¤ºåç§°
            Column() {
              Text('æ˜¾ç¤ºåç§°')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              TextInput({ 
                placeholder: 'è¯·è¾“å…¥æ˜¾ç¤ºåç§°ï¼ˆå¯ä¸­æ–‡ï¼‰',
                text: this.newCalendarDisplayName
              })
                .onChange((value: string) => {
                  this.newCalendarDisplayName = value;
                })
                .width('100%')
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // è´¦æˆ·é¢œè‰²
            Column() {
              Text('è´¦æˆ·é¢œè‰²')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              Row() {
                ForEach(['#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0', '#607D8B'], (color: string) => {
                  Stack() {
                    // é¢œè‰²åœ†åœˆ
                    Circle()
                      .width(40)
                      .height(40)
                      .fill(color)
                    
                    // é€‰ä¸­æ ‡è®°
                    if (this.newCalendarColor === color) {
                      Text('âœ“')
                        .fontSize(18)
                        .fontColor('#FFFFFF')
                        .fontWeight(FontWeight.Bold)
                    }
                  }
                  .width(40)
                  .height(40)
                  .onClick(() => {
                    this.newCalendarColor = color;
                  })
                  .margin({ right: 12 })
                })
              }
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })
            
            // æé†’è®¾ç½®
            Row() {
              Checkbox()
                .select(this.enableReminder)
                .onChange((value: boolean) => {
                  this.enableReminder = value;
                })
              
              Text('å¯ç”¨æ—¥ç¨‹æé†’')
                .fontSize(16)
                .margin({ left: 8 })
            }
            .alignItems(VerticalAlign.Center)
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 20 })
            
            // æŒ‰é’®è¡Œ
            Row() {
              Button() {
                Text('å–æ¶ˆ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('sys.color.ohos_id_color_text_primary'))
              }
              .type(ButtonType.Normal)
              .backgroundColor('transparent')
              .width('45%')
              .height(50)
              .onClick(() => {
                this.showCreateDialog = false;
                this.clearCreateForm();
              })

              Button() {
                Text('åˆ›å»ºè´¦æˆ·')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Color.White)
              }
              .type(ButtonType.Capsule)
              .backgroundColor('#4CAF50')
              .width('45%')
              .height(50)
              .onClick(() => {
                this.createNewCalendar();
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('90%')
          .padding(20)
          .backgroundColor($r('sys.color.ohos_id_color_background'))
          .borderRadius(12)
          .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.3)' })
          
          Blank()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showCreateDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }
} 