// Index.ets - AIæ™ºèƒ½æ—¥ç¨‹åˆ›å»ºä¸»é¡µ
import { router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { calendarManager } from '@kit.CalendarKit';
import { promptAction } from '@kit.ArkUI';
import { calendarMgr, mContext, AITextParser, AIConfig, ParsedEventData } from '../entryability/EntryAbility';

@Entry
@Component
struct Index {
  @State message: string = 'ğŸ¤– AIæ™ºèƒ½æ—¥ç¨‹åŠ©æ‰‹'
  
  // æ—¥å†ç›¸å…³çŠ¶æ€
  @State calendar: calendarManager.Calendar | undefined = undefined
  
  // ä¼ ç»Ÿæ—¥ç¨‹è¡¨å•çŠ¶æ€
  @State eventTitle: string = ''
  @State eventDescription: string = ''
  @State eventLocation: string = ''
  @State selectedEventType: number = 0
  @State reminderMinutes: number = 10
  @State isRecurring: boolean = false
  @State selectedFrequency: number = 0
  @State recurringCount: number = 1
  
  // æ—¶é—´ç›¸å…³çŠ¶æ€
  @State startDate: string = ''
  @State startTime: string = ''
  @State endDate: string = ''
  @State endTime: string = ''
  
  // AIè§£æç›¸å…³çŠ¶æ€
  @State aiInputText: string = ''
  @State showAIConfig: boolean = false
  @State apiKey: string = ''
  @State baseUrl: string = 'https://api.deepseek.com'
  @State model: string = 'deepseek-chat'
  @State isAIParsing: boolean = false
  @State showTraditionalForm: boolean = false
  
  // é€‰é¡¹æ•°ç»„
  private eventTypes: string[] = ['æ™®é€šæ—¥ç¨‹', 'é‡è¦æ—¥ç¨‹']

  // åˆå§‹åŒ–æ—¥å†è´¦æˆ·
  async initCalendar() {
    try {
      if (!calendarMgr) {
        promptAction.showToast({
          message: 'æ—¥å†ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè¯·é‡å¯åº”ç”¨',
          duration: 2000
        });
        return;
      }
      
      // è·å–æˆ–åˆ›å»ºæ—¥å†è´¦æˆ·
      const calendarAccount: calendarManager.CalendarAccount = {
        name: 'MyCalendar',
        type: calendarManager.CalendarType.LOCAL,
        displayName: 'æˆ‘çš„æ—¥å†è´¦æˆ·'
      };
      
      try {
        this.calendar = await calendarMgr.getCalendar(calendarAccount);
        console.info('Calendar account already exists');
      } catch (getError) {
        this.calendar = await calendarMgr.createCalendar(calendarAccount);
        const config: calendarManager.CalendarConfig = {
          enableReminder: true,
          color: '#4CAF50'
        };
        await this.calendar.setConfig(config);
        console.info('Calendar account created successfully');
      }
      
      console.info('Calendar initialized successfully');
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`Failed to initialize calendar. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆå§‹åŒ–æ—¥å†å¤±è´¥: ' + message,
        duration: 2000
      });
    }
  }

  // åˆ›å»ºæ—¥ç¨‹
  async createEvent() {
    try {
      if (!this.calendar) {
        await this.initCalendar();
      }
      
      if (!this.calendar) {
        promptAction.showToast({
          message: 'æ—¥å†æœªåˆå§‹åŒ–',
          duration: 2000
        });
        return;
      }

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!this.eventTitle.trim()) {
        promptAction.showToast({
          message: 'è¯·è¾“å…¥æ—¥ç¨‹æ ‡é¢˜',
          duration: 2000
        });
        return;
      }

      // è§£ææ—¶é—´
      const now = new Date();
      const startDateTime = this.parseDateTime(this.startDate, this.startTime) || now.getTime();
      const endDateTime = this.parseDateTime(this.endDate, this.endTime) || (startDateTime + 60 * 60 * 1000);

      if (endDateTime <= startDateTime) {
        promptAction.showToast({
          message: 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´',
          duration: 2000
        });
        return;
      }

      // æ„å»ºæ—¥ç¨‹å¯¹è±¡
      let eventType = calendarManager.EventType.NORMAL;
      if (this.selectedEventType === 1) {
        eventType = calendarManager.EventType.IMPORTANT;
      }

      let reminderArray: number[] = [];
      if (this.reminderMinutes > 0) {
        reminderArray = [this.reminderMinutes];
      }

      const event: calendarManager.Event = {
        title: this.eventTitle,
        description: this.eventDescription,
        type: eventType,
        startTime: startDateTime,
        endTime: endDateTime,
        reminderTime: reminderArray
      };

      // å¦‚æœæœ‰åœ°ç‚¹ä¿¡æ¯ï¼Œæ·»åŠ locationå­—æ®µ
      if (this.eventLocation.trim()) {
        const locationInfo: calendarManager.Location = {
          location: this.eventLocation,
          latitude: 0,
          longitude: 0
        };
        event.location = locationInfo;
      }

      // æ·»åŠ é‡å¤è§„åˆ™ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (this.isRecurring && this.recurringCount > 0) {
        let frequency = calendarManager.RecurrenceFrequency.DAILY;
        if (this.selectedFrequency === 1) {
          frequency = calendarManager.RecurrenceFrequency.WEEKLY;
        } else if (this.selectedFrequency === 2) {
          frequency = calendarManager.RecurrenceFrequency.MONTHLY;
        } else if (this.selectedFrequency === 3) {
          frequency = calendarManager.RecurrenceFrequency.YEARLY;
        }
        
        event.recurrenceRule = {
          recurrenceFrequency: frequency,
          count: this.recurringCount,
          interval: 1
        };
      }

      // åˆ›å»ºæ—¥ç¨‹
      const eventId = await this.calendar.addEvent(event);
      
      promptAction.showToast({
        message: `æ—¥ç¨‹åˆ›å»ºæˆåŠŸï¼ID: ${eventId}`,
        duration: 2000
      });
      
      // æ¸…ç©ºè¡¨å•
      this.clearForm();
      
      console.info(`Event created successfully, ID: ${eventId}`);
    } catch (err) {
      let code = (err as BusinessError).code;
      let message = (err as BusinessError).message;
      console.error(`Failed to create event. Code: ${code}, message: ${message}`);
      promptAction.showToast({
        message: 'åˆ›å»ºæ—¥ç¨‹å¤±è´¥: ' + message,
        duration: 2000
      });
    }
  }

  // è§£ææ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
  parseDateTime(dateStr: string, timeStr: string): number | null {
    if (!dateStr || !timeStr) return null;
    
    try {
      const dateTimeStr = `${dateStr}T${timeStr}:00`;
      const dateTime = new Date(dateTimeStr);
      return dateTime.getTime();
    } catch (error) {
      console.error('è§£ææ—¶é—´å¤±è´¥:', error);
      return null;
    }
  }

  // é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½AIé…ç½®
  async aboutToAppear() {
    await this.loadAIConfig();
  }

  // åŠ è½½AIé…ç½®
  async loadAIConfig() {
    if (mContext) {
      const config = await AIConfig.getConfig(mContext);
      this.apiKey = config.apiKey;
      this.baseUrl = config.baseUrl;
      this.model = config.model;
    }
  }

  // ä¿å­˜AIé…ç½®
  async saveAIConfig() {
    if (mContext) {
      await AIConfig.saveConfig(mContext, this.apiKey, this.baseUrl, this.model);
      this.showAIConfig = false;
      promptAction.showToast({
        message: 'AIé…ç½®ä¿å­˜æˆåŠŸ',
        duration: 2000
      });
    }
  }

  // AIè§£æè‡ªç„¶è¯­è¨€
  async parseWithAI() {
    if (!this.aiInputText.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥æ—¥ç¨‹æè¿°',
        duration: 2000
      });
      return;
    }

    if (!this.apiKey.trim()) {
      promptAction.showToast({
        message: 'è¯·å…ˆé…ç½®API Key',
        duration: 2000
      });
      this.showAIConfig = true;
      return;
    }

    this.isAIParsing = true;

    try {
      const parser = new AITextParser(this.apiKey, this.baseUrl, this.model);
      const parsedData = await parser.parseText(this.aiInputText);
      
      // å°†è§£æç»“æœå¡«å…¥è¡¨å•
      this.fillFormWithParsedData(parsedData);
      
      promptAction.showToast({
        message: 'AIè§£ææˆåŠŸï¼è¯·æ£€æŸ¥å¹¶ç¡®è®¤ä¿¡æ¯',
        duration: 2000
      });
      
      // æ˜¾ç¤ºä¼ ç»Ÿè¡¨å•ä¾›ç”¨æˆ·ç¡®è®¤
      this.showTraditionalForm = true;
      
    } catch (error) {
      console.error('AIè§£æå¤±è´¥:', error);
      promptAction.showToast({
        message: `AIè§£æå¤±è´¥: ${error.message}`,
        duration: 3000
      });
    } finally {
      this.isAIParsing = false;
    }
  }

  // å°†AIè§£æç»“æœå¡«å…¥è¡¨å•
  fillFormWithParsedData(data: ParsedEventData) {
    this.eventTitle = data.summary;
    this.eventDescription = data.description || '';
    this.eventLocation = data.location || '';
    this.reminderMinutes = data.reminderMinutes;
    this.isRecurring = data.isRecurring;
    
    // è§£ææ—¶é—´
    if (data.startTime) {
      const startDateTime = new Date(data.startTime);
      this.startDate = startDateTime.toISOString().split('T')[0];
      this.startTime = startDateTime.toTimeString().split(' ')[0].substring(0, 5);
    }
    
    if (data.endTime) {
      const endDateTime = new Date(data.endTime);
      this.endDate = endDateTime.toISOString().split('T')[0];
      this.endTime = endDateTime.toTimeString().split(' ')[0].substring(0, 5);
    }
    
    // è®¾ç½®é‡å¤é¢‘ç‡
    if (data.isRecurring && data.recurrenceFrequency) {
      switch (data.recurrenceFrequency) {
        case 'daily':
          this.selectedFrequency = 0;
          break;
        case 'weekly':
          this.selectedFrequency = 1;
          break;
        case 'monthly':
          this.selectedFrequency = 2;
          break;
        case 'yearly':
          this.selectedFrequency = 3;
          break;
      }
      this.recurringCount = data.recurrenceCount || 1;
    }
  }

  // æ¸…ç©ºè¡¨å•
  clearForm() {
    this.eventTitle = '';
    this.eventDescription = '';
    this.eventLocation = '';
    this.selectedEventType = 0;
    this.reminderMinutes = 10;
    this.isRecurring = false;
    this.selectedFrequency = 0;
    this.recurringCount = 1;
    this.startDate = '';
    this.startTime = '';
    this.endDate = '';
    this.endTime = '';
    this.aiInputText = '';
    this.showTraditionalForm = false;
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹
      Scroll() {
        Column() {
          // æ ‡é¢˜å’Œæ—¥å†ç®¡ç†æŒ‰é’®
          Row() {
            Text(this.message)
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
            
            Blank()
            
            Button() {
              Text(' æ—¥å†è´¦æˆ·ç®¡ç† ')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
            }
            .type(ButtonType.Capsule)
            .backgroundColor('#9C27B0')
            .height(40)
            .onClick(() => {
              router.pushUrl({ url: 'pages/CalendarManager' }).then(() => {
                console.info('Succeeded in jumping to calendar manager page.')
              }).catch((err: BusinessError) => {
                console.error(`Failed to jump to calendar manager page. Code is ${err.code}, message is ${err.message}`)
              })
            })
          }
          .width('100%')
          .margin({ bottom: 20 })
          
          // AIè§£æåŒºåŸŸ
          if (!this.showTraditionalForm) {
            Column() {
              Text('åªéœ€ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„æ—¥ç¨‹ï¼ŒAIå°†è‡ªåŠ¨ä¸ºæ‚¨è§£æå¹¶åˆ›å»º')
                .fontSize(16)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .margin({ bottom: 16 })
                .textAlign(TextAlign.Center)
              
              // AIè¾“å…¥æ¡†
              TextArea({ 
                placeholder: 'ä¾‹å¦‚ï¼šæ˜å¤©ä¸‹åˆ3ç‚¹åœ¨ä¼šè®®å®¤å¼€äº§å“è¯„å®¡ä¼šï¼Œæå‰30åˆ†é’Ÿæé†’æˆ‘',
                text: this.aiInputText
              })
                .onChange((value: string) => {
                  this.aiInputText = value;
                })
                .width('100%')
                .height(120)
                .margin({ bottom: 16 })
              
              // æ“ä½œæŒ‰é’®è¡Œ
              Row() {
                Button() {
                  if (this.isAIParsing) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .color(Color.White)
                  } else {
                    Text('ğŸš€ AIè§£æ')
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(Color.White)
                  }
                }
                .type(ButtonType.Capsule)
                .backgroundColor('#4CAF50')
                .width('45%')
                .height(55)
                .enabled(!this.isAIParsing)
                .onClick(() => {
                  this.parseWithAI();
                })

                Button() {
                  Text('âš™ï¸ é…ç½®')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .type(ButtonType.Capsule)
                .backgroundColor('#FF9800')
                .width('25%')
                .height(55)
                .onClick(() => {
                  this.showAIConfig = true;
                })

                Button() {
                  Text('ğŸ“ æ‰‹åŠ¨')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .type(ButtonType.Capsule)
                .backgroundColor('#2196F3')
                .width('25%')
                .height(55)
                .onClick(() => {
                  this.showTraditionalForm = true;
                })
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .margin({ bottom: 20 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
            .borderRadius(12)
            .margin({ bottom: 20 })
          }

          // ä¼ ç»Ÿè¡¨å•åŒºåŸŸ
          if (this.showTraditionalForm) {
            Column() {
              // æ ‡é¢˜å’Œè¿”å›æŒ‰é’®è¡Œ
              Row() {
                Text('ğŸ“‹ æ—¥ç¨‹è¯¦æƒ…ç¡®è®¤')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                
                Blank()
                
                Button() {
                  Text('è¿”å›AI')
                    .fontSize(14)
                    .fontColor($r('sys.color.ohos_id_color_text_primary'))
                }
                .type(ButtonType.Normal)
                .backgroundColor('transparent')
                .onClick(() => {
                  this.showTraditionalForm = false;
                })
              }
              .width('100%')
              .margin({ bottom: 16 })

              // æ“ä½œæŒ‰é’®åŒºåŸŸ - åœ¨æœ€ä¸Šé¢
              Row() {
                Button() {
                  Text('âœ… åˆ›å»ºæ—¥ç¨‹')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .type(ButtonType.Capsule)
                .backgroundColor('#4CAF50')
                .width('48%')
                .height(45)
                .onClick(() => {
                  this.createEvent();
                })

                Button() {
                  Text('ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .type(ButtonType.Capsule)
                .backgroundColor('#FF9800')
                .width('48%')
                .height(45)
                .onClick(() => {
                  this.clearForm();
                })
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .margin({ bottom: 20 })
              
              // æ—¥ç¨‹æ ‡é¢˜è¾“å…¥
              Column() {
                Text('ğŸ“ æ—¥ç¨‹æ ‡é¢˜ *')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                TextInput({ placeholder: 'è¯·è¾“å…¥æ—¥ç¨‹æ ‡é¢˜', text: this.eventTitle })
                  .onChange((value: string) => {
                    this.eventTitle = value;
                  })
                  .width('100%')
              }
              .width('100%')
              .margin({ bottom: 16 })

              // æ—¥ç¨‹æè¿°è¾“å…¥
              Column() {
                Text('ğŸ“„ æ—¥ç¨‹æè¿°')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                TextArea({ placeholder: 'è¯·è¾“å…¥æ—¥ç¨‹æè¿°', text: this.eventDescription })
                  .onChange((value: string) => {
                    this.eventDescription = value;
                  })
                  .width('100%')
                  .height(80)
              }
              .width('100%')
              .margin({ bottom: 16 })

              // æ—¥ç¨‹åœ°ç‚¹è¾“å…¥
              Column() {
                Text('ğŸ“ æ—¥ç¨‹åœ°ç‚¹')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                TextInput({ placeholder: 'è¯·è¾“å…¥æ—¥ç¨‹åœ°ç‚¹', text: this.eventLocation })
                  .onChange((value: string) => {
                    this.eventLocation = value;
                  })
                  .width('100%')
              }
              .width('100%')
              .margin({ bottom: 16 })

              // å¼€å§‹æ—¶é—´
              Column() {
                Text('ğŸ• å¼€å§‹æ—¶é—´')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                Row() {
                  TextInput({ placeholder: 'YYYY-MM-DD', text: this.startDate })
                    .type(InputType.Normal)
                    .onChange((value: string) => {
                      this.startDate = value;
                    })
                    .width('48%')
                  
                  TextInput({ placeholder: 'HH:MM', text: this.startTime })
                    .type(InputType.Normal)
                    .onChange((value: string) => {
                      this.startTime = value;
                    })
                    .width('48%')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .width('100%')
              .margin({ bottom: 16 })

              // ç»“æŸæ—¶é—´
              Column() {
                Text('ğŸ•‘ ç»“æŸæ—¶é—´')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                Row() {
                  TextInput({ placeholder: 'YYYY-MM-DD', text: this.endDate })
                    .type(InputType.Normal)
                    .onChange((value: string) => {
                      this.endDate = value;
                    })
                    .width('48%')
                  
                  TextInput({ placeholder: 'HH:MM', text: this.endTime })
                    .type(InputType.Normal)
                    .onChange((value: string) => {
                      this.endTime = value;
                    })
                    .width('48%')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .width('100%')
              .margin({ bottom: 16 })

              // æ—¥ç¨‹ç±»å‹é€‰æ‹©
              Column() {
                Text('ğŸ·ï¸ æ—¥ç¨‹ç±»å‹')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                Row() {
                  ForEach(this.eventTypes, (type: string, index: number) => {
                    Row() {
                      Radio({ value: `type_${index}`, group: 'eventType' })
                        .checked(this.selectedEventType === index)
                        .onChange((isChecked: boolean) => {
                          if (isChecked) {
                            this.selectedEventType = index;
                          }
                        })
                      
                      Text(type)
                        .fontSize(14)
                        .margin({ left: 8 })
                    }
                    .margin({ right: 20 })
                  })
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 16 })

              // æé†’æ—¶é—´é€‰æ‹©
              Column() {
                Text('â° æé†’æ—¶é—´')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                Row() {
                  ForEach([0, 5, 10, 15, 30, 60], (minutes: number, index: number) => {
                    Row() {
                      Radio({ value: `reminder_${index}`, group: 'reminderTime' })
                        .checked(this.reminderMinutes === minutes)
                        .onChange((isChecked: boolean) => {
                          if (isChecked) {
                            this.reminderMinutes = minutes;
                          }
                        })
                      
                      Text(minutes === 0 ? 'ä¸æé†’' : `æå‰${minutes}åˆ†é’Ÿ`)
                        .fontSize(12)
                        .margin({ left: 4 })
                    }
                    .margin({ right: 10 })
                  })
                }
                .width('100%')
              }
              .width('100%')
              .margin({ bottom: 16 })

              // é‡å¤è®¾ç½®
              Column() {
                Row() {
                  Checkbox()
                    .select(this.isRecurring)
                    .onChange((value: boolean) => {
                      this.isRecurring = value;
                    })
                  
                  Text('ğŸ”„ é‡å¤æ—¥ç¨‹')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .margin({ left: 8 })
                }
                .alignItems(VerticalAlign.Center)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

                if (this.isRecurring) {
                  Column() {
                    Text('é‡å¤é¢‘ç‡')
                      .fontSize(14)
                      .alignSelf(ItemAlign.Start)
                      .margin({ bottom: 8 })
                      .fontColor($r('sys.color.ohos_id_color_text_primary'))
                    
                    Row() {
                      ForEach(['æ¯å¤©', 'æ¯å‘¨', 'æ¯æœˆ', 'æ¯å¹´'], (freq: string, index: number) => {
                        Row() {
                          Radio({ value: `freq_${index}`, group: 'frequency' })
                            .checked(this.selectedFrequency === index)
                            .onChange((isChecked: boolean) => {
                              if (isChecked) {
                                this.selectedFrequency = index;
                              }
                            })
                          
                          Text(freq)
                            .fontSize(14)
                            .margin({ left: 8 })
                            .fontColor($r('sys.color.ohos_id_color_text_primary'))
                        }
                        .margin({ right: 20 })
                      })
                    }
                    .width('100%')
                    .margin({ bottom: 8 })

                    Text('é‡å¤æ¬¡æ•°')
                      .fontSize(14)
                      .alignSelf(ItemAlign.Start)
                      .margin({ bottom: 8 })
                      .fontColor($r('sys.color.ohos_id_color_text_primary'))
                    
                    TextInput({ placeholder: 'è¯·è¾“å…¥é‡å¤æ¬¡æ•°', text: this.recurringCount.toString() })
                      .type(InputType.Number)
                      .onChange((value: string) => {
                        const num = parseInt(value);
                        if (!isNaN(num) && num > 0) {
                          this.recurringCount = num;
                        }
                      })
                      .width('100%')
                  }
                  .padding(16)
                  .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
                  .borderRadius(8)
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 20 })
            }
            .width('100%')
            .padding(20)
          }
        }
        .width('100%')
        .padding(20)
      }
      .height('100%')
      .width('100%')

      // AIé…ç½®å¼¹çª—
      if (this.showAIConfig) {
        Column() {
          Blank()
          
          // é…ç½®é¢æ¿
          Column() {
            Text('ğŸ¤– AIé…ç½®')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })
            
            // API Keyè¾“å…¥
            Column() {
              Text('API Key *')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              TextInput({ 
                placeholder: 'è¯·è¾“å…¥æ‚¨çš„API Key',
                text: this.apiKey
              })
                .type(InputType.Password)
                .onChange((value: string) => {
                  this.apiKey = value;
                })
                .width('100%')
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // Base URLè¾“å…¥
            Column() {
              Text('APIåœ°å€')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              TextInput({ 
                placeholder: 'https://api.deepseek.com',
                text: this.baseUrl
              })
                .onChange((value: string) => {
                  this.baseUrl = value;
                })
                .width('100%')
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // æ¨¡å‹é€‰æ‹©
            Column() {
              Text('æ¨¡å‹')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              TextInput({ 
                placeholder: 'deepseek-chat',
                text: this.model
              })
                .onChange((value: string) => {
                  this.model = value;
                })
                .width('100%')
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            // æŒ‰é’®è¡Œ
            Row() {
              Button() {
                Text('å–æ¶ˆ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('sys.color.ohos_id_color_text_primary'))
              }
              .type(ButtonType.Normal)
              .backgroundColor('transparent')
              .width('45%')
              .height(50)
              .onClick(() => {
                this.showAIConfig = false;
              })

              Button() {
                Text('ä¿å­˜é…ç½®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Color.White)
              }
              .type(ButtonType.Capsule)
              .backgroundColor('#4CAF50')
              .width('45%')
              .height(50)
              .onClick(() => {
                this.saveAIConfig();
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('90%')
          .padding(20)
          .backgroundColor($r('sys.color.ohos_id_color_background'))
          .borderRadius(12)
          .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.3)' })
          
          Blank()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showAIConfig = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }
} 